<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; margin: 0; padding: 12px; font-size: 14px; background-color: #f8f9fa; }
      .container { display: flex; flex-direction: column; gap: 12px; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; background-color: #ffffff; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
      .form-group { margin-bottom: 12px; }
      label { display: block; font-weight: bold; margin-bottom: 4px; font-size: 0.9em; }
      input, select, textarea { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
      textarea { resize: vertical; min-height: 60px; }
      button { width: 100%; padding: 10px; font-size: 1em; color: white; border: none; border-radius: 4px; cursor: pointer; background-color: #007bff; }
      .config-notice { text-align: center; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 4px; }
      .status-message { text-align: center; padding: 8px; margin-top: 10px; border-radius: 4px; display: none; }
      .status-success { background-color: #d4edda; color: #155724; }
      .status-error { background-color: #f8d7da; color: #721c24; }
      .time-input-group { display: flex; align-items: center; }
      .time-input-group input { width: 75%; }
      .time-input-group .capture-btn { width: auto; margin-left: 8px; padding: 6px 10px; font-size: 0.9em; background-color: #6c757d; }
      /* NEW style for the autosave indicator */
      #autosave-status { font-size: 0.8em; color: #6c757d; text-align: right; height: 1em; transition: opacity 0.5s; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <? if (!isConfigured) { ?>
          <div class="config-notice">
            <p>Please run 'Doc Tools > Writing Tracker > Configure Tracker...' to connect your Google Sheet.</p>
          </div>
        <? } else { ?>
          <form id="log-form">
            <!-- Each field is now populated by the 'savedData' object if it exists -->
            <div class="form-group">
              <label for="date">Date</label>
              <input type="text" id="date" name="date" value="<?= savedData.date || today ?>">
            </div>
            <div class="form-group">
              <label for="timeStart">Time Start</label>
              <div class="time-input-group">
                <input type="text" id="timeStart" name="timeStart" placeholder="HH:MM:SS" value="<?= savedData.timeStart || '' ?>">
                <button type="button" class="capture-btn" onclick="captureTime('timeStart')">Now</button>
              </div>
            </div>
             <div class="form-group">
              <label for="timeStop">Time Stop</label>
              <div class="time-input-group">
                <input type="text" id="timeStop" name="timeStop" placeholder="HH:MM:SS" value="<?= savedData.timeStop || '' ?>">
                <button type="button" class="capture-btn" onclick="captureTime('timeStop')">Now</button>
              </div>
            </div>
             <div class="form-group">
              <label for="xp">XP (Word Count)</label>
              <input type="number" id="xp" name="xp" value="<?= savedData.xp || 0 ?>">
            </div>
            <div class="form-group">
              <label for="activity">Activity</label>
              <select id="activity" name="activity">
                <option <?= savedData.activity == 'Writing' ? 'selected' : '' ?>>Writing</option>
                <option <?= savedData.activity == 'Editing' ? 'selected' : '' ?>>Editing</option>
                <option <?= savedData.activity == 'Ideating' ? 'selected' : '' ?>>Ideating</option>
                <option <?= savedData.activity == 'Planning' ? 'selected' : '' ?>>Planning</option>
                <option <?= savedData.activity == 'Workflow' ? 'selected' : '' ?>>Workflow</option>
                <option <?= savedData.activity == 'Creative' ? 'selected' : '' ?>>Creative</option>
                <option <?= savedData.activity == 'Reading' ? 'selected' : '' ?>>Reading</option>
                <option <?= savedData.activity == 'Reward' ? 'selected' : '' ?>>Reward</option>
                <option <?= savedData.activity == 'Missed' ? 'selected' : '' ?>>Missed</option>
              </select>
            </div>
            <div class="form-group">
              <label for="manuscript">Manuscript</label>
              <input type="text" id="manuscript" name="manuscript" value="<?= savedData.manuscript || manuscript ?>">
            </div>
            <div class="form-group">
              <label for="notes">Notes</label>
              <textarea id="notes" name="notes"><?= savedData.notes || '' ?></textarea>
            </div>
            <div class="form-group">
              <label><input type="checkbox" id="isLevelUp" name="isLevelUp" <?= savedData.isLevelUp ? 'checked' : '' ?>> Mark as Level-Up Day</label>
            </div>
            <button type="button" id="logButton" onclick="logSession()">Log to Sheet</button>
            <div id="status" class="status-message"></div>
            <div id="autosave-status"></div>
          </form>
        <? } ?>
      </div>
    </div>

    <!-- NEW script block with memory functions -->
    <script>
      // Run this after the page loads
      window.onload = function() {
        // Attach a single event listener to the form that triggers on any change
        document.getElementById('log-form').addEventListener('change', autoSaveChanges);
      };

      function captureTime(fieldId) {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const timeField = document.getElementById(fieldId);
        timeField.value = `${hours}:${minutes}:${seconds}`;
        // Manually trigger the 'change' event so the form auto-saves
        timeField.dispatchEvent(new Event('change'));
      }

      function getCurrentFormData() {
        return {
          date: document.getElementById('date').value,
          timeStart: document.getElementById('timeStart').value,
          timeStop: document.getElementById('timeStop').value,
          xp: document.getElementById('xp').value,
          activity: document.getElementById('activity').value,
          manuscript: document.getElementById('manuscript').value,
          notes: document.getElementById('notes').value,
          isLevelUp: document.getElementById('isLevelUp').checked
        };
      }

      // This function silently saves the form's state in the background
      function autoSaveChanges() {
        const statusEl = document.getElementById('autosave-status');
        statusEl.textContent = 'Saving...';
        statusEl.style.opacity = '1';

        const formData = getCurrentFormData();
        google.script.run
          .withSuccessHandler(function() {
            setTimeout(function() {
              statusEl.style.opacity = '0';
            }, 1000); // Fade out after 1 second
          })
          .saveTrackerState(formData);
      }
      
      function logSession() {
        const btn = document.getElementById('logButton');
        const statusEl = document.getElementById('status');
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.textContent = 'Logging...';
        statusEl.style.display = 'none';

        const formData = getCurrentFormData();
        
        google.script.run
          .withSuccessHandler(function() {
            statusEl.textContent = 'Logged successfully!';
            statusEl.className = 'status-message status-success';
            statusEl.style.display = 'block';
            document.getElementById('log-form').reset();
            document.getElementById('date').value = '<?= today ?>';
            document.getElementById('manuscript').value = '<?= manuscript ?>';
            setTimeout(function() {
              btn.disabled = false;
              btn.style.opacity = '1';
              btn.textContent = 'Log to Sheet';
              statusEl.style.display = 'none';
            }, 2500);
          })
          .withFailureHandler(function(error) {
            statusEl.textContent = 'Error: ' + error.message;
            statusEl.className = 'status-message status-error';
            statusEl.style.display = 'block';
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.textContent = 'Log to Sheet';
          })
          .logSessionToSheet(formData);
      }
    </script>
  </body>
</html>
